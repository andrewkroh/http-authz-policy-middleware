name: Generate Changelog

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name (e.g., v0.2.0) - leave empty for unreleased changes'
        required: false
        type: string

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Install git-cliff
        run: |
          cargo install git-cliff

      - name: Generate Changelog (Unreleased)
        if: ${{ github.event.inputs.tag == '' }}
        run: |
          echo "Generating changelog for unreleased changes..."
          git cliff --unreleased --prepend CHANGELOG.md

      - name: Generate Changelog (Tagged Release)
        if: ${{ github.event.inputs.tag != '' }}
        run: |
          echo "Generating changelog for tag: ${{ github.event.inputs.tag }}"
          git cliff --tag ${{ github.event.inputs.tag }} --prepend CHANGELOG.md

      - name: Show Changelog Preview
        run: |
          echo "=== CHANGELOG.md Preview ==="
          head -n 100 CHANGELOG.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update CHANGELOG.md"
          title: "chore: update CHANGELOG.md"
          body: |
            Automated changelog update generated by git-cliff.

            Please review the changes before merging.
          branch: changelog-update
          delete-branch: true
