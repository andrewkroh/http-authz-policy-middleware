name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog generation

      - name: Validate tag format
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Creating release for tag: $TAG"
          if ! [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Tag must follow semantic versioning (e.g., v1.2.3)"
            exit 1
          fi

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1

      - name: Install wasm-opt
        run: |
          echo "Installing wasm-opt for binary optimization..."
          cargo install wasm-opt

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release WASM
        run: |
          echo "Building optimized WASM plugin with make release..."
          make release
          SIZE=$(stat -c%s plugin.wasm)
          SIZE_KB=$((SIZE / 1024))
          echo "Optimized binary size: ${SIZE_KB} KB"

          # Verify the binary was optimized
          if [ $SIZE_KB -lt 700 ]; then
            echo "✓ Binary is optimized (~650 KB expected)"
          else
            echo "⚠ Warning: Binary seems larger than expected (>700 KB)"
            echo "Expected: ~650 KB with wasm-opt optimization"
          fi

      - name: Install git-cliff
        run: cargo install git-cliff

      - name: Generate release notes
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Generating release notes for $TAG..."
          git cliff --tag "$TAG" --unreleased --strip all > release-notes.md

          echo "=== Release Notes Preview ==="
          cat release-notes.md

      - name: Package plugin for Traefik catalog
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          ARCHIVE_NAME="http-authz-policy-middleware-${TAG}.zip"

          echo "Creating plugin package: $ARCHIVE_NAME"
          zip -j "$ARCHIVE_NAME" plugin.wasm .traefik.yml

          echo "Package contents:"
          unzip -l "$ARCHIVE_NAME"

          ls -lh "$ARCHIVE_NAME"

          # Save archive name for later steps
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.ARCHIVE_NAME }}
            plugin.wasm
            .traefik.yml
          body_path: release-notes.md
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $TAG" >> $GITHUB_STEP_SUMMARY
          echo "**Archive:** ${{ env.ARCHIVE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- \`plugin.wasm\` - Compiled WASM plugin" >> $GITHUB_STEP_SUMMARY
          echo "- \`.traefik.yml\` - Plugin manifest" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.ARCHIVE_NAME }}\` - Complete plugin package (for Traefik catalog)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify release artifacts on GitHub Releases page" >> $GITHUB_STEP_SUMMARY
          echo "2. Test the plugin package with Traefik" >> $GITHUB_STEP_SUMMARY
          echo "3. Submit to Traefik Plugin Catalog (if desired)" >> $GITHUB_STEP_SUMMARY
