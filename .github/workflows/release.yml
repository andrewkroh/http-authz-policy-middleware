name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.2.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if ! [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must follow semantic versioning (e.g., v1.2.3)"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION_NUMBER=${VERSION#v}" >> $GITHUB_ENV

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for changelog generation

      - name: Check tag does not already exist
        run: |
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Error: Tag $VERSION already exists"
            exit 1
          fi

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
          targets: wasm32-wasip1

      - name: Install wasm-opt
        run: cargo install wasm-opt

      - name: Install git-cliff
        run: cargo install git-cliff

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Run quality checks
        run: make check

      - name: Run tests
        run: make test

      - name: Build release WASM
        run: make release

      - name: Run integration tests
        run: |
          cd integration-test
          chmod +x run-tests.sh
          ./run-tests.sh

      - name: Show Traefik logs on failure
        if: failure()
        run: |
          cd integration-test
          docker compose logs traefik || echo "Could not retrieve logs"
          docker compose down || true

      - name: Update Cargo.toml version
        run: |
          CURRENT=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          if [ "$CURRENT" != "$VERSION_NUMBER" ]; then
            echo "Updating Cargo.toml version from $CURRENT to $VERSION_NUMBER"
            sed -i "s/^version = \".*\"/version = \"$VERSION_NUMBER\"/" Cargo.toml
          else
            echo "Cargo.toml already at version $VERSION_NUMBER"
          fi

      - name: Commit version bump
        run: |
          if git diff --quiet Cargo.toml; then
            echo "No version change to commit"
          else
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add Cargo.toml
            git commit -m "chore: bump version to $VERSION_NUMBER"
            git push origin main
          fi

      - name: Create and push tag
        run: |
          git tag "$VERSION"
          git push origin "$VERSION"

      - name: Generate release notes
        run: |
          echo "Generating release notes for $VERSION..."
          git cliff --tag "$VERSION" --unreleased --strip all > release-notes.md
          echo "=== Release Notes Preview ==="
          cat release-notes.md

      - name: Package plugin for Traefik catalog
        run: |
          ARCHIVE_NAME="http-authz-policy-middleware-${VERSION}.zip"
          echo "Creating plugin package: $ARCHIVE_NAME"
          zip -j "$ARCHIVE_NAME" plugin.wasm .traefik.yml
          echo "Package contents:"
          unzip -l "$ARCHIVE_NAME"
          ls -lh "$ARCHIVE_NAME"
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV

      - name: Report binary size
        run: |
          SIZE=$(stat -c%s plugin.wasm)
          SIZE_KB=$((SIZE / 1024))
          echo "Optimized binary size: ${SIZE_KB} KB"
          if [ $SIZE_KB -gt 750 ]; then
            echo "Warning: Binary size exceeds 750 KB (expected ~650 KB)"
          else
            echo "Binary size within expected range"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          files: |
            ${{ env.ARCHIVE_NAME }}
            plugin.wasm
            .traefik.yml
          body_path: release-notes.md
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Archive:** ${{ env.ARCHIVE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- \`plugin.wasm\` - Compiled WASM plugin" >> $GITHUB_STEP_SUMMARY
          echo "- \`.traefik.yml\` - Plugin manifest" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.ARCHIVE_NAME }}\` - Complete plugin package (for Traefik catalog)" >> $GITHUB_STEP_SUMMARY
